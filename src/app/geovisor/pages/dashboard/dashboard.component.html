<div class="h-screen w-full bg-slate-100 antialiased selection:bg-blue-600 selection:text-white">
  <!-- Navbar: Se asume que tiene una altura de h-16 (4rem) y es fixed -->
  <app-navbarmenu (menuToggle)="isMenuOpen = !isMenuOpen"></app-navbarmenu>

  <div class="flex h-full pt-16">
    <!-- üìö Men√∫ Lateral (Sidebar) -->
    <!-- En m√≥vil es un overlay que se desliza. En desktop es est√°tico. -->
    <!-- La l√≥gica de isDesktop y isMenuOpen es crucial y debe venir del TS (BreakpointObserver) -->
    <app-sidemenu
      class="fixed inset-y-0 left-0 z-30 w-64 bg-[#323232] transition-transform duration-300 ease-in-out pt-16 md:static md:translate-x-0 md:pt-0"
      [class.translate-x-0]="isMenuOpen"
      [class.-translate-x-full]="!isMenuOpen && !isDesktop">
    </app-sidemenu>

    <!-- Fondo oscuro para el overlay en m√≥vil -->
    <div *ngIf="isMenuOpen && !isDesktop" (click)="isMenuOpen = false" class="fixed inset-0 z-20 bg-black/50 md:hidden"></div>

    <!-- üìä Contenido Principal -->
    <main class="flex-1 min-w-0 p-4 sm:p-6 overflow-y-auto space-y-6">

    <h1 id="dashboard-title" class="text-base sm:text-lg md:text-xl font-semibold text-white bg-[#0DA642] px-3 py-2 rounded-lg shadow-md text-center">
      <ng-container [ngSwitch]="selectedYear">
        <ng-container *ngSwitchCase="0">
          Informaci√≥n Acumulada (Todos los a√±os)
        </ng-container>
        <ng-container *ngSwitchCase="2024">
          Informaci√≥n de la Meta 2024
        </ng-container>
        <ng-container *ngSwitchCase="2025">
          Informaci√≥n vigente al {{ currentDate | date:'longDate' }}
        </ng-container>
        <ng-container *ngSwitchDefault>
          Informaci√≥n correspondiente al a√±o {{ selectedYear }}
        </ng-container>
      </ng-container>
    </h1>
    <!-- Agrega esto donde quieras que aparezca el selector de a√±o -->
    <div class="flex flex-wrap items-center justify-center gap-4">
      <div id="year-selector-container" class="inline-flex items-center bg-white rounded-lg shadow-sm border border-gray-300 p-1">
        <label for="year-select" class="px-3 text-base sm:text-lg font-semibold text-gray-600">Seleccionar A√±o:</label>
        <select id="year-select" (change)="onYearChange($event)" class="rounded-md border-transparent bg-transparent py-2 pl-2 pr-8 text-base sm:text-lg font-medium text-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          <option [value]="0" [selected]="selectedYear === 0">Todos</option>
          <option *ngFor="let year of availableYears" [value]="year" [selected]="year === selectedYear">
            {{ year }}
          </option>
        </select>
      </div>
      <!-- Bot√≥n para iniciar el tour -->
      <button (click)="startDashboardTour()" class="flex items-center gap-2 bg-[#0D9BD7] hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition-all duration-300 text-sm sm:text-base">
        ‚ú® Iniciar Tour Virtual
      </button>
    </div>
    <!-- ESTADISTICA SOBRE HECTAREAS -->
    <div id="hectareas-section" class="rounded-2xl bg-[#0D9BD7] p-6 shadow-md ring-1 ring-gray-200">
      <!-- T√≠tulo de la tarjeta principal -->
      <h2 class="text-xl sm:text-2xl font-semibold text-black mb-6">
        HECT√ÅREAS (CACAO & CAF√â)
      </h2>
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 text-white">
        <!-- Meta Total -->
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-800 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6 text-white">META</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ currentMetaHectareas | number :
              "1.0-0" }}</p>
          </div>
          <img src="assets/images/dashboard/meta.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
        <!-- Hect√°reas Total en Cultivos -->
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6">AVANCE CAF√â & CACAO</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ totalAreaCultivo | number : "1.0-0"
              }}</p>
          </div>
          <img src="assets/images/dashboard/avance.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
        <!-- Hect√°reas de Cacao -->
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6">AVANCE CACAO</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ totalAreaCacao | number : "1.0-0"
              }}</p>
          </div>
          <img src="assets/images/dashboard/grano_cacao.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
        <!-- Hect√°reas de Caf√© -->
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6">AVANCE CAF√â</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ totalAreaCafe | number : "1.0-0"
              }}</p>
          </div>
          <img src="assets/images/dashboard/grano_cafe.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
      </div>
    </div>
    <div class="bg-white rounded-2xl shadow-lg border p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Gr√°fico 1 -->
        <div class="relative h-80 md:h-96">
          <canvas id="graficoMeta"></canvas>
        </div>
        <!-- Gr√°fico 2 (barras horizontales) -->
        <div class="relative h-80 md:h-96">
          <canvas id="graficoMetaOZ"></canvas>
        </div>
      </div>
    </div>
    <!-- estaditica con meta -->
    <!-- <div class="bg-white rounded-2xl shadow-lg border p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-1">
        <div class="w-full h-[280px] sm:h-[380px] md:h-[450px] lg:h-[500px] 3xl:h-[650px] max-w-full mx-auto">
          <canvas id="graficoMetaOZCAFE" class="w-full h-full"></canvas>
        </div>
        <div class="w-full h-[280px] sm:h-[380px] md:h-[450px] lg:h-[500px] 3xl:h-[650px] max-w-full mx-auto">
          <canvas id="graficoMetaOZCACAO" class="w-full h-full"></canvas>
        </div>
      </div>
    </div> -->
    <!-- ESTADISTICA SOBRE FAMILIAS -->
    <div id="familias-section" class="rounded-2xl bg-[#0D9BD7] p-6 shadow-md ring-1 ring-gray-200">
      <h2 class="text-xl sm:text-2xl font-bold text-black mb-6">
        FAMILIAS PARTICIPANTES EN CULTIVOS DE CACAO & CAF√â
      </h2>
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-5 text-white">
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6 text-white">META</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ currentMetaFamilias | number :
              "1.0-0" }}</p>
          </div>
          <img src="assets/images/dashboard/meta.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6">AVANCE</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ totalRegistrosUnicosDNI["total"] |
              number : "1.0-0" }}</p>
          </div>
          <img src="assets/images/dashboard/avance.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6">AVANCE CACAO</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ totalRegistrosUnicosDNI["cacao"] |
              number : "1.0-0" }}</p>
          </div>
          <img src="assets/images/dashboard/grano_cacao.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6">AVANCE CAF√â</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ totalRegistrosUnicosDNI["cafe"] |
              number : "1.0-0" }}</p>
          </div>
          <img src="assets/images/dashboard/grano_cafe.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
        <div class="rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer hover:bg-gray-700 transition-colors" (click)="showCafeYCacaoReport()">
          <p class="text-sm sm:text-base font-medium leading-tight">PARTICIPANTES EN AMBOS</p>
          <p class="mt-2 flex items-baseline gap-x-2">
            <span class="text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">
              {{ totalRegistrosUnicosDNI["cafe_y_cacao"] | number : "1.0-0" }}
            </span>
          </p>
        </div>
      </div>
    </div>
    <div class="bg-white rounded-2xl shadow-lg border p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Gr√°fico 1 -->
        <div class="relative h-80 md:h-96">
          <canvas id="graficoMetaDNI"></canvas>
        </div>
        <!-- Gr√°fico 2 (barras horizontales) -->
        <div class="relative h-80 md:h-96">
          <canvas id="graficoMetaParticipantes"></canvas>
        </div>
      </div>
    </div>
    <!-- FIN ESTADISTICA SOBRE FAMILIAS -->
    <div class="bg-white rounded-2xl shadow-lg border p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Gr√°fico 2 (barras horizontales) -->
        <div class="relative h-80 md:h-96">
          <canvas id="graficoCantidadDNIOZCACAO"></canvas>
        </div>
        <!-- Gr√°fico 1 -->
        <div class="relative h-80 md:h-96">
          <canvas id="graficoCantidadDNIOZCAFE"></canvas>
        </div>
      </div>
    </div>
    <!-- ESTADISTICA POLIGONOS -->
    <div id="poligonos-section" class="rounded-2xl bg-[#0D9BD7] p-6 shadow-md ring-1 ring-gray-200">
      <h2 class="text-xl sm:text-2xl font-bold text-black mb-6">
        POL√çGONOS DE CACAO & CAF√â
      </h2>
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 text-white">
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6 text-white">AVANCE</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ totalRegistrosCultivos | number :
              "1.0-0" }}</p>
          </div>
          <img src="assets/images/dashboard/avance.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
        <!--  <div class="rounded-2xl bg-gray-900 p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <p class="text-xl font-medium leading-6 text-white">EN PROCESO</p>
          <p class="mt-2 flex items-baseline gap-x-2">
            <span class="text-4xl font-semibold tracking-tight text-green-400">
              {{ totalRegistrosUnicosDNI[""] | number : "1.0-0" }}
            </span>
          </p>
        </div> -->
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6">AVANCE CACAO</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ totalCacao | number : "1.0-0"}}</p>
          </div>
          <img src="assets/images/dashboard/grano_cacao.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
        <div
          class="flex items-center justify-between rounded-2xl bg-gray-900 p-4 sm:p-6 shadow ring-1 ring-white/10 cursor-pointer">
          <div>
            <p class="text-base sm:text-lg font-medium leading-6">AVANCE CAF√â</p>
            <p class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-green-400">{{ totalCafe | number : "1.0-0"}}</p>
          </div>
          <img src="assets/images/dashboard/grano_cafe.png" alt="icono"
            class="w-12 h-12 sm:w-16 sm:h-16 opacity-80 rounded-full drop-shadow-[0_0_10px_white]">
        </div>
      </div>
    </div>
    <!-- FIN ESTADISTICA POLIGONOS -->
    <div class="bg-white rounded-2xl shadow-lg border p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Gr√°fico 2 (barras horizontales) -->
        <div class="relative h-80 md:h-96">
          <canvas id="graficoCantidadOZCACAO"></canvas>
        </div>
        <!-- Gr√°fico 1 -->
        <div class="relative h-80 md:h-96">
          <canvas id="graficoCantidadOZCAFE"></canvas>
        </div>
      </div>
    </div>
    <!-- NUEVO GR√ÅFICO POR DEPARTAMENTO -->
    <div id="departamento-section" class="bg-white rounded-2xl shadow-lg border p-6">
      <h2 class="text-xl sm:text-2xl font-bold text-black mb-6">
        CANTIDAD DE POL√çGONOS POR DEPARTAMENTO
      </h2>
      <div class="relative h-96">
        <canvas id="graficoPorDepartamento"></canvas>
      </div>
    </div>
    <br>
    <br>
    <app-footer/>

    <!-- Modal para el Reporte de Participantes en Ambos Cultivos -->
    <div *ngIf="isModalVisible" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" (click)="closeModal()">
      <div class="bg-white rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col" (click)="$event.stopPropagation()">
        <!-- Cabecera del Modal -->
        <div class="flex justify-between items-center p-4 border-b">
          <h3 class="text-xl font-bold text-gray-800">Reporte: Participantes en Caf√© y Cacao</h3>
          <button (click)="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>

        <!-- Contenido del Modal -->
        <div class="p-6 overflow-auto">
          <!-- Estado de Carga -->
          <div *ngIf="isModalLoading" class="flex flex-col items-center justify-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Cargando reporte...</p>
          </div>

          <!-- Tabla de Datos -->
          <div *ngIf="!isModalLoading && modalData.length > 0" class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="min-w-full border-collapse">
              <thead class="bg-gray-200">
                <tr>
                  <th scope="col" class="px-4 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wider border-b border-gray-300">DNI</th>
                  <th scope="col" class="px-4 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wider border-b border-gray-300">Nombres</th>
                  <th scope="col" class="px-4 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wider border-b border-gray-300">C√≥digo del Plan</th>
                  <th scope="col" class="px-4 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wider border-b border-gray-300">Cultivo</th>
                  <th scope="col" class="px-4 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wider border-b border-gray-300">Fecha Levantamiento</th>
                  <th scope="col" class="px-4 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wider border-b border-gray-300">Oficina Zonal</th>
                  <th scope="col" class="px-4 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wider border-b border-gray-300">Departamento</th>
                  <th scope="col" class="px-4 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wider border-b border-gray-300">Provincia</th>
                  <th scope="col" class="px-4 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wider border-b border-gray-300">Distrito</th>
                </tr>
              </thead>
              <tbody class="bg-white">
                <tr *ngFor="let item of modalData" class="even:bg-gray-50 hover:bg-blue-100 transition-colors">
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 border-b border-gray-200">{{ item.dni_participante }}</td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 border-b border-gray-200">{{ item.nombres }}</td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600 border-b border-gray-200">{{ item.codigo_plan }}</td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600 border-b border-gray-200">{{ item.tipo_cultivo }}</td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600 border-b border-gray-200">{{ item.fecha_levantamiento | date:'dd/MM/yyyy' }}</td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600 border-b border-gray-200">{{ item.oficina_zonal }}</td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600 border-b border-gray-200">{{ item.departamento }}</td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600 border-b border-gray-200">{{ item.provincia }}</td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600 border-b border-gray-200">{{ item.distrito }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Sin Datos -->
          <div *ngIf="!isModalLoading && modalData.length === 0" class="text-center text-gray-500 py-16">
            <p>No se encontraron participantes en ambos cultivos para el per√≠odo seleccionado.</p>
          </div>
        </div>
      </div>
    </div>
    </main>
  </div>
</div>